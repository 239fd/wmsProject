version: "3.8"

services:
  # ==================== DATABASES ====================
  postgres-sso:
    image: postgres:16-alpine
    container_name: postgres-sso
    restart: unless-stopped
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - pg_data_sso:/var/lib/postgresql/data
      - ./sql-scripts/userDB.sql:/docker-entrypoint-initdb.d/01-userDB.sql:ro
    networks:
      - wms-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d user_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-org:
    image: postgres:16-alpine
    container_name: postgres-org
    restart: unless-stopped
    environment:
      POSTGRES_DB: organization_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
    volumes:
      - pg_data_org:/var/lib/postgresql/data
      - ./sql-scripts/organizationDB.sql:/docker-entrypoint-initdb.d/01-organizationDB.sql:ro
    networks:
      - wms-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d organization_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-warehouse:
    image: postgres:16-alpine
    container_name: postgres-warehouse
    restart: unless-stopped
    environment:
      POSTGRES_DB: warehouse_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5434:5432"
    volumes:
      - pg_data_warehouse:/var/lib/postgresql/data
      - ./sql-scripts/warehouseDB.sql:/docker-entrypoint-initdb.d/01-warehouseDB.sql:ro
    networks:
      - wms-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d warehouse_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-product:
    image: postgres:16-alpine
    container_name: postgres-product
    restart: unless-stopped
    environment:
      POSTGRES_DB: product_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5435:5432"
    volumes:
      - pg_data_product:/var/lib/postgresql/data
      - ./sql-scripts/productDB.sql:/docker-entrypoint-initdb.d/01-productDB.sql:ro
    networks:
      - wms-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d product_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== INFRASTRUCTURE ====================
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - wms-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - wms-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== BACKEND SERVICES ====================
  eureka-server:
    build:
      context: ./backend/eureka-server
      dockerfile: Dockerfile
    container_name: eureka-server
    restart: unless-stopped
    ports:
      - "8761:8761"
    networks:
      - wms-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  api-gateway:
    build:
      context: ./backend/api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    restart: unless-stopped
    ports:
      - "8765:8765"
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka
      SSO_SERVICE_URL: http://sso-service:8000
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - wms-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  sso-service:
    build:
      context: ./backend/SSOService
      dockerfile: Dockerfile
    container_name: sso-service
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      SERVER_PORT: 8000
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-sso:5432/user_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "true"
    depends_on:
      postgres-sso:
        condition: service_healthy
      redis:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    networks:
      - wms-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  organization-service:
    build:
      context: ./backend/organization-service
      dockerfile: Dockerfile
    container_name: organization-service
    restart: unless-stopped
    ports:
      - "8010:8010"
    environment:
      SERVER_PORT: 8010
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-org:5432/organization_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "true"
    depends_on:
      postgres-org:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    networks:
      - wms-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  product-service:
    build:
      context: ./backend/product-service
      dockerfile: Dockerfile
    container_name: product-service
    restart: unless-stopped
    ports:
      - "8030:8030"
    environment:
      SERVER_PORT: 8030
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-product:5432/product_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "true"
    depends_on:
      postgres-product:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    networks:
      - wms-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  warehouse-service:
    build:
      context: ./backend/warehouse-service
      dockerfile: Dockerfile
    container_name: warehouse-service
    restart: unless-stopped
    ports:
      - "8020:8020"
    environment:
      SERVER_PORT: 8020
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-warehouse:5432/warehouse_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "true"
    depends_on:
      postgres-warehouse:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    networks:
      - wms-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8020/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  document-service:
    build:
      context: ./backend/document-service
      dockerfile: Dockerfile
    container_name: document-service
    restart: unless-stopped
    ports:
      - "8040:8040"
    environment:
      SERVER_PORT: 8040
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "true"
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - wms-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8040/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==================== FRONTEND ====================
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: wms-client
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      api-gateway:
        condition: service_healthy
    networks:
      - wms-network

networks:
  wms-network:
    driver: bridge

volumes:
  pg_data_sso:
  pg_data_org:
  pg_data_warehouse:
  pg_data_product:
  redis_data:
  rabbitmq_data:

